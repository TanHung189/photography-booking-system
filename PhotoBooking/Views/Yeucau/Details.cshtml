@model PhotoBooking.Models.YeuCau
@using System.Security.Claims

@{
    ViewData["Title"] = "Chi tiết yêu cầu: " + Model.TieuDe;
    
    // Lấy ID người dùng hiện tại để phân quyền hiển thị
    var userIdString = User.FindFirst("Id")?.Value ?? User.FindFirst(ClaimTypes.NameIdentifier)?.Value;
    int currentUserId = 0;
    int.TryParse(userIdString, out currentUserId);

    // Kiểm tra xem người xem có phải là chủ bài đăng không
    bool isOwner = (Model.MaKhachHang == currentUserId);
}

<div class="container py-5">
    
    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="fas fa-check-circle me-2"></i> @TempData["Success"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }
    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-circle me-2"></i> @TempData["Error"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    <div class="row g-5">
        <div class="col-lg-4">
            <div class="card shadow-sm border-0 sticky-top" style="top: 100px; z-index: 1;">
                <div class="card-body p-4">
                    <h6 class="text-uppercase text-muted fw-bold small ls-1 mb-3">Thông tin dự án</h6>
                    <h3 class="fw-bold mb-3">@Model.TieuDe</h3>
                    
                    <div class="mb-3">
                        @if(Model.TrangThai == 0) { <span class="badge bg-success">Đang tìm thợ</span> }
                        else if(Model.TrangThai == 1) { <span class="badge bg-warning text-dark">Đã chốt đơn</span> }
                        else { <span class="badge bg-secondary">Đã hủy</span> }
                    </div>
                    
                    <hr class="opacity-10">
                    
                    <div class="d-flex justify-content-between mb-2">
                        <span class="text-muted"><i class="fas fa-coins me-2"></i>Ngân sách:</span>
                        <span class="fw-bold text-success fs-5">@Model.NganSach?.ToString("N0") đ</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span class="text-muted"><i class="far fa-calendar-alt me-2"></i>Ngày chụp:</span>
                        <span class="fw-bold">@Model.NgayCanChup?.ToString("dd/MM/yyyy")</span>
                    </div>
                    <div class="mb-3">
                        <span class="text-muted d-block mb-1"><i class="fas fa-map-marker-alt me-2"></i>Địa điểm:</span>
                        <span class="fw-bold">@Model.DiaChi</span>
                    </div>

                    <div class="bg-light p-3 rounded border">
                        <small class="text-uppercase text-muted fw-bold" style="font-size: 0.7rem;">Mô tả chi tiết</small>
                        <p class="mb-0 mt-1" style="white-space: pre-line;">@Model.MoTa</p>
                    </div>

                    <div class="d-flex align-items-center mt-4 pt-3 border-top">
                        <div class="avatar-circle bg-secondary text-white rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px;">
                            <i class="fas fa-user"></i>
                        </div>
                        <div>
                            <small class="text-muted d-block">Đăng bởi</small>
                            <span class="fw-bold">@Model.MaKhachHangNavigation?.HoVaTen</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-8">
            
            @if (isOwner)
            {
                // =========================================================
                // TRƯỜNG HỢP 1: NGƯỜI XEM LÀ CHỦ NHÀ (KHÁCH HÀNG)
                // =========================================================
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h4 class="fw-bold m-0">📸 Danh sách báo giá (@Model.UngTuyens.Count)</h4>
                    <span class="text-muted small">Hãy chọn nhiếp ảnh gia phù hợp nhất</span>
                </div>

                @if (Model.UngTuyens.Count == 0)
                {
                    <div class="text-center py-5 bg-light rounded border border-dashed">
                        <i class="fas fa-camera-retro fa-3x text-muted mb-3"></i>
                        <p class="text-muted">Chưa có nhiếp ảnh gia nào ứng tuyển.</p>
                    </div>
                }
                else
                {
                    <div class="row g-3">
                        @foreach (var item in Model.UngTuyens)
                        {
                            <div class="col-12">
                                <div class="card shadow-sm border-0 hover-shadow @(item.TrangThai == 1 ? "border-success border-2" : "")">
                                    <div class="card-body">
                                        <div class="d-flex align-items-start">
                                            <img src="@(item.MaNhiepAnhGiaNavigation.AnhDaiDien ?? $"https://ui-avatars.com/api/?name={item.MaNhiepAnhGiaNavigation.HoVaTen}&background=random")"
                                                 class="rounded-circle me-3 border shadow-sm" width="70" height="70" style="object-fit:cover">

                                            <div class="flex-grow-1">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <div>
                                                        <h5 class="fw-bold mb-1">
                                                            <a href="/Photographer/Details/@item.MaNhiepAnhGia" target="_blank" class="text-decoration-none text-dark">
                                                                @item.MaNhiepAnhGiaNavigation.HoVaTen
                                                            </a>
                                                        </h5>
                                                        <p class="text-muted small mb-2"><i class="far fa-clock me-1"></i>Ứng tuyển: @item.NgayUngTuyen?.ToString("dd/MM HH:mm")</p>
                                                    </div>
                                                    <div class="text-end">
                                                        <div class="fs-4 fw-bold text-primary">@item.GiaBao.ToString("N0") đ</div>
                                                        <small class="text-muted">Đề xuất</small>
                                                    </div>
                                                </div>

                                                <div class="bg-light p-3 rounded mt-2 fst-italic text-secondary border-start border-4 border-warning">
                                                    "@item.LoiNhan"
                                                </div>

                                                @if (Model.TrangThai == 0)
                                                {
                                                    <div class="mt-3 text-end">
                                                        <form asp-controller="YeuCau" asp-action="AcceptBid" method="post">
                                                            <input type="hidden" name="idUngTuyen" value="@item.MaUngTuyen" />
                                                            <button type="submit" class="btn btn-dark rounded-pill fw-bold px-4" 
                                                                    onclick="return confirm('Bạn có chắc muốn chọn thợ này? Hệ thống sẽ tạo đơn hàng ngay lập tức.')">
                                                                <i class="fas fa-check-circle me-2"></i>CHẤP NHẬN BÁO GIÁ NÀY
                                                            </button>
                                                        </form>
                                                    </div>
                                                }
                                                else if (item.TrangThai == 1)
                                                {
                                                    <div class="mt-3 text-end">
                                                        <span class="badge bg-success fs-6 px-3 py-2"><i class="fas fa-check me-1"></i> ĐÃ CHỌN NGƯỜI NÀY</span>
                                                    </div>
                                                }
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                }
            }
            else
            {
                // =========================================================
                // TRƯỜNG HỢP 2: NGƯỜI XEM LÀ NHIẾP ẢNH GIA (HOẶC KHÁCH VÃNG LAI)
                // =========================================================
                
                @if (User.IsInRole("Photographer"))
                {
                    <div class="card shadow border-0">
                        <div class="card-body p-4">
                            @if (ViewBag.HoSoCuaToi != null)
                            {
                                // --- ĐÃ ỨNG TUYỂN ---
                                var myBid = (PhotoBooking.Models.UngTuyen)ViewBag.HoSoCuaToi;

                                if (myBid.TrangThai == 0)
                                {
                                    <div class="text-center py-4">
                                        <div class="mb-3"><i class="fas fa-hourglass-half fa-4x text-warning"></i></div>
                                        <h3 class="fw-bold">Đã gửi báo giá!</h3>
                                        <p class="fs-5">Bạn đã báo giá: <strong class="text-primary">@myBid.GiaBao.ToString("N0") đ</strong></p>
                                        <p class="text-muted">Hồ sơ của bạn đang được khách hàng xem xét.</p>
                                        <button class="btn btn-outline-secondary disabled">Đang chờ phản hồi...</button>
                                    </div>
                                }
                                else if (myBid.TrangThai == 1)
                                {
                                    <div class="text-center py-4">
                                        <div class="mb-3"><i class="fas fa-check-circle fa-4x text-success"></i></div>
                                        <h3 class="fw-bold text-success">Bạn đã được chọn!</h3>
                                        <p>Khách hàng đã đồng ý hợp tác. Vui lòng kiểm tra đơn hàng để tiến hành công việc.</p>
                                        <a href="/Photographer/MyJobs" class="btn btn-success btn-lg shadow">Xem chi tiết công việc</a>
                                    </div>
                                }
                            }
                            else
                            {
                                // --- CHƯA ỨNG TUYỂN (Hiện Form) ---
                                @if (Model.TrangThai == 0)
                                {
                                    <h4 class="fw-bold mb-4"><i class="fas fa-rocket me-2 text-warning"></i>Ứng tuyển ngay</h4>
                                    <form asp-controller="YeuCau" asp-action="ApplyJob" method="post">
                                        <input type="hidden" name="MaYeuCau" value="@Model.MaYeuCau" />
                                        
                                        <div class="mb-4">
                                            <label class="form-label fw-bold text-dark">Mức giá bạn đề xuất (VNĐ)</label>
                                            <div class="input-group">
                                                <span class="input-group-text bg-white fw-bold text-success">₫</span>
                                                <input type="number" name="GiaBao" class="form-control form-control-lg fw-bold text-success" 
                                                       placeholder="Nhập số tiền..." required min="100000" step="50000">
                                            </div>
                                            <div class="form-text">Hãy đưa ra mức giá cạnh tranh so với ngân sách @Model.NganSach?.ToString("N0") đ của khách.</div>
                                        </div>

                                        <div class="mb-4">
                                            <label class="form-label fw-bold text-dark">Lời nhắn gửi khách hàng</label>
                                            <textarea name="LoiNhan" class="form-control" rows="4" 
                                                placeholder="Chào bạn, mình rất hứng thú với dự án này. Mình có kinh nghiệm chụp..."></textarea>
                                        </div>

                                        <div class="d-grid">
                                            <button type="submit" class="btn btn-primary btn-lg fw-bold shadow-sm">
                                                <i class="fas fa-paper-plane me-2"></i> GỬI BÁO GIÁ
                                            </button>
                                        </div>
                                    </form>
                                }
                                else
                                {
                                    <div class="alert alert-secondary text-center">
                                        <i class="fas fa-lock me-2"></i> Công việc này đã kết thúc.
                                    </div>
                                }
                            }
                        </div>
                    </div>
                }
                else
                {
                    // --- KHÁCH VÃNG LAI HOẶC CHƯA ĐĂNG NHẬP ---
                    <div class="alert alert-warning text-center">
                        Bạn cần đăng nhập với tài khoản <strong>Nhiếp ảnh gia</strong> để ứng tuyển công việc này.
                        <div class="mt-2">
                            <a href="/Account/Login" class="btn btn-warning btn-sm fw-bold">Đăng nhập ngay</a>
                        </div>
                    </div>
                }
            }
        </div>
    </div>
</div>